<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Prenotazione Laboratorio Multimediale</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background: #f8f9fa;
      padding: 20px;
    }
    .container {
      max-width: 600px;
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0px 0px 10px rgba(0,0,0,0.1);
    }
    h2 {
      margin-bottom: 20px;
    }
    .btn-primary {
      transition: background-color 0.3s ease, transform 0.2s ease;
    }
    .btn-primary:hover {
      background-color: #0056b3;
      transform: scale(1.05);
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>

<div class="container">
  <h2 class="text-center">Prenota il Laboratorio Multimediale</h2>

  <!-- Login Section -->
  <div id="loginSection" class="text-center">
    <div id="g_id_onload"
      data-client_id="YOUR_PUBLIC_GOOGLE_CLIENT_ID.apps.googleusercontent.com"
      data-callback="handleCredentialResponse"
      data-auto_prompt="false">
    </div>

    <div class="g_id_signin" data-type="standard"></div>

    <p class="mt-3 text-muted">Accedi con il tuo account <strong>@isufol.it</strong></p>
  </div>

  <!-- Form Section -->
  <form id="formPrenotazioneLab" class="hidden mt-4">
    <div class="form-group mb-3">
      <label for="attrezzatura">Scegli Attrezzatura:</label>
      <select class="form-control" id="attrezzatura" name="attrezzatura" required>
        <option value="">Seleziona...</option>
        <option value="Lab. multimediale">Lab. multimediale</option>
        <option value="Carrello 30 notebook">Carrello 30 notebook</option>
        <option value="Carrello 25 iPad">Carrello 25 iPad</option>
      </select>
    </div>

    <!-- Campi per il Lab. multimediale -->
    <div id="labFields" class="hidden">
      <div class="form-group mb-3">
        <label for="giorno">Data prenotazione:</label>
        <input type="date" class="form-control" id="giorno" name="giorno">
      </div>
      <div class="form-group mb-3">
        <label for="ora">Ora prenotazione:</label>
        <select class="form-control" id="ora" name="ora">
          <option value="">Seleziona ora...</option>
          <option value="1ª ora">1ª ora</option>
          <option value="2ª ora">2ª ora</option>
          <option value="3ª ora">3ª ora</option>
          <option value="4ª ora">4ª ora</option>
          <option value="5ª ora">5ª ora</option>
          <option value="6ª ora">6ª ora</option>
        </select>
      </div>
      <div class="form-group mb-3">
        <label for="note">Note:</label>
        <textarea class="form-control" id="note" name="note" rows="3" placeholder="Indicare argomento o richieste particolari..."></textarea>
      </div>
    </div>

    <!-- Campi per i Carrelli -->
    <div id="carrelloFields" class="hidden">
      <div class="form-group mb-3">
        <label for="aula">Aula di destinazione:</label>
        <select class="form-control" id="aula" name="aula">
          <option value="">Seleziona aula...</option>
          <option value="Andromeda">Andromeda</option>
          <option value="Cassiopea">Cassiopea</option>
          <option value="Lyra">Lyra</option>
          <option value="Orione">Orione</option>
          <option value="1A LS">1A LS</option>
          <option value="2A LS">2A LS</option>
          <option value="3A LS">3A LS</option>
          <option value="4A LS">4A LS</option>
          <option value="5A LS">5A LS</option>
          <option value="1B LSA">1B LSA</option>
          <option value="2B LSA">2B LSA</option>
          <option value="5B LSA">5B LSA</option>
          <option value="1C LSU">1C LSU</option>
          <option value="2C LSU">2C LSU</option>
          <option value="3C LSU">3C LSU</option>
          <option value="4C LSU">4C LSU</option>
          <option value="5C LSU">5C LSU</option>
          <option value="1F LS">1F LS</option>
          <option value="2F LS">2F LS</option>
          <option value="5F LS">5F LS</option>
          <option value="1G LSU">1G LSU</option>
          <option value="2G LSU">2G LSU</option>
          <option value="3G LSU">3G LSU</option>
          <option value="4G LSU">4G LSU</option>
          <option value="1H LSA">1H LSA</option>
          <option value="2H LSA">2H LSA</option>
          <option value="5H LSA">5H LSA</option>
          <option value="Lab. Fisica">Lab. Fisica</option>
          <option value="Lab. Chimica">Lab. Chimica</option>
          <option value="Aula Magna">Aula Magna</option>
        </select>
      </div>
      <div class="form-group mb-3">
        <label for="numDispositivi">Numero dispositivi richiesti:</label>
        <input type="number" class="form-control" id="numDispositivi" name="numDispositivi" min="1">
      </div>
      <div class="form-group mb-3">
        <label for="giornoCarrello">Data prenotazione:</label>
        <input type="date" class="form-control" id="giornoCarrello" name="giornoCarrello">
      </div>
      <div class="form-group mb-3">
        <label for="oraCarrello">Ora prenotazione:</label>
        <select class="form-control" id="oraCarrello" name="oraCarrello">
          <option value="">Seleziona ora...</option>
          <option value="1ª ora">1ª ora</option>
          <option value="2ª ora">2ª ora</option>
          <option value="3ª ora">3ª ora</option>
          <option value="4ª ora">4ª ora</option>
          <option value="5ª ora">5ª ora</option>
          <option value="6ª ora">6ª ora</option>
        </select>
      </div>
      <div class="form-group mb-3">
        <label for="noteCarrello">Note:</label>
        <textarea class="form-control" id="noteCarrello" name="noteCarrello" rows="3" placeholder="Indicare argomento o richieste particolari..."></textarea>
      </div>
    </div>

    <button type="submit" class="btn btn-primary w-100">Invia Prenotazione</button>
  </form>
</div>

<script>
  let userEmail = "";
  let tokenPolling = null;
  let tokenVerification = ''; // Store token received from email

  function handleCredentialResponse(response) {
    const decoded = jwt_decode(response.credential);
    if (decoded.email && decoded.email.endsWith("@isufol.it")) {
      if (confirm(`Sei loggato come ${decoded.email}. È corretto?`)) {
        userEmail = decoded.email;
        document.getElementById('loginSection').classList.add('hidden');
        document.getElementById('formPrenotazioneLab').classList.remove('hidden');
        startPolling(); // Start polling once logged in
      } else {
        alert("Effettua il login con il tuo account corretto @isufol.it");
        window.location.reload();
      }
    } else {
      alert("Devi usare un account @isufol.it per continuare.");
      window.location.reload();
    }
  }

  function startPolling() {
    fetch('https://script.google.com/macros/s/YOUR_DEPLOYED_WEBAPP_ID/exec?action=requestVerification&email=' + userEmail)
      .then(res => res.json())
      .then(data => {
        if (data.result === "success") {
          tokenVerification = data.token; // Store token received
          pollTokenVerification(tokenVerification); // Start polling for token verification
        } else {
          alert("Errore: " + data.message);
        }
      })
      .catch(error => {
        console.error('Errore nella richiesta:', error);
      });
  }

  function pollTokenVerification(token) {
    tokenPolling = setInterval(() => {
      fetch('https://script.google.com/macros/s/YOUR_DEPLOYED_WEBAPP_ID/exec?action=checkToken&token=' + token)
        .then(res => res.json())
        .then(data => {
          if (data.verified) {
            clearInterval(tokenPolling);
            document.getElementById('formPrenotazioneLab').classList.remove('hidden'); // Show form when token is verified
          }
        });
    }, 5000); // Check every 5 seconds
  }

  document.getElementById('attrezzatura').addEventListener('change', function() {
    const selected = this.value;
    document.getElementById('labFields').classList.toggle('hidden', selected !== "Lab. multimediale");
    document.getElementById('carrelloFields').classList.toggle('hidden', selected === "Lab. multimediale");
  });

  document.getElementById('formPrenotazioneLab').addEventListener('submit', function(e) {
    e.preventDefault();

    const attrezzatura = document.getElementById('attrezzatura').value;
    const data = {
      email: userEmail,
      attrezzatura: attrezzatura,
      giorno: attrezzatura === "Lab. multimediale" ? document.getElementById('giorno').value : document.getElementById('giornoCarrello').value,
      ora: attrezzatura === "Lab. multimediale" ? document.getElementById('ora').value : document.getElementById('oraCarrello').value,
      note: attrezzatura === "Lab. multimediale" ? document.getElementById('note').value : document.getElementById('noteCarrello').value,
      aula: attrezzatura !== "Lab. multimediale" ? document.getElementById('aula').value : "",
      numDispositivi: attrezzatura !== "Lab. multimediale" ? document.getElementById('numDispositivi').value : ""
    };

    fetch('https://script.google.com/macros/s/YOUR_DEPLOYED_WEBAPP_ID/exec', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(response => {
      if (response.result === "success") {
        alert("Prenotazione inviata con successo!");
        window.location.reload();
      } else {
        alert("Errore: " + response.message);
      }
    })
    .catch(error => {
      console.error('Errore nella richiesta:', error);
      alert('Errore durante l\'invio della prenotazione.');
    });
  });
</script>

</body>
</html>
